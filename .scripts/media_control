#!/bin/sh

# media_control - A script to control media playback for MPC, Playerctl, and MPV
# It toggles/next/prev current playing source or last played source
# The last played source is managed in /tmp/last_played
#
# Usage:
#   ./media_control                  # Print currently playing media or last played one
#   ./media_control toggle           # Toggle play/pause
#   ./media_control next             # Play the next track
#   ./media_control prev             # Play the previous track

LAST_PLAYED_FILE="/tmp/last_played"
[[ -f "$LAST_PLAYED_FILE" ]] || touch "$LAST_PLAYED_FILE"

# Returns "source#title" if playing
check_playing_media() {
    MPV_SOCKET_DIR="/tmp/mpvSockets"

    # Check if MPD is playing
    if mpc status | grep -q '\[playing\]'; then
        echo "mpc#$(mpc current)"

    # Check if playerctl is playing (e.g., Chrome/YouTube)
    elif playerctl status 2>/dev/null | grep -q 'Playing'; then
        echo "playerctl#$(playerctl metadata --format '{{title}}')"

    # Check if mpv is playing by looking for the socket file
    else
        MPV_PID=$(pgrep -n mpv)
        MPV_SOCKET="${MPV_SOCKET_DIR}/${MPV_PID}"

        if [[ -n "$MPV_PID" && -S "$MPV_SOCKET" ]]; then
            STATUS=$(echo '{ "command": ["get_property", "pause"] }' | socat - "$MPV_SOCKET" | jq -r '.data')
            if [[ "$STATUS" == "false" ]]; then
                TITLE=$(echo '{ "command": ["get_property", "media-title"] }' | socat - "$MPV_SOCKET" | jq -r '.data')
                [[ -n "$TITLE" ]] && echo "mpv#$TITLE"
            fi
        fi
    fi
}

# Get the title of currently playing media or (paused) title
get_media_title() {
    PLAYING="$(check_playing_media)"

    if [ -n "$PLAYING" ]; then
        # Update the last played title in the file
        echo "$PLAYING" > "$LAST_PLAYED_FILE"
        echo "$PLAYING" | cut -d'#' -f2
    else
        if [ -f "$LAST_PLAYED_FILE" ]; then
            PAUSED_TITLE="$(cat $LAST_PLAYED_FILE | cut -d'#' -f2)"
            echo "(paused) $PAUSED_TITLE"
        else
            echo "(paused) Unknown Title"
        fi
    fi
}

# Toggle play/pause based on the currently playing media or last played media
toggle_play() {
    SOURCE="$(check_playing_media)"
    [ -z "$SOURCE" ] && SOURCE="$(cat $LAST_PLAYED_FILE)"

    # Update the LAST_PLAYED_FILE when playing media
    case "$SOURCE" in
        mpc#*)
            mpc toggle > /dev/null
            ;;
        playerctl#*)
            playerctl play-pause > /dev/null
            ;;
        mpv#*)
            MPV_PID=$(pgrep -n mpv)
            MPV_SOCKET="/tmp/mpvSockets/${MPV_PID}"
            STATUS=$(echo '{ "command": ["get_property", "pause"] }' | socat - "$MPV_SOCKET" | jq -r '.data')

            if [[ $STATUS == "true" ]]; then
                echo '{ "command": ["set_property", "pause", false] }' | socat - "$MPV_SOCKET" > /dev/null
            else
                echo '{ "command": ["set_property", "pause", true] }' | socat - "$MPV_SOCKET" > /dev/null
            fi
            ;;
        *)
            mpc toggle > /dev/null # defaults to mpc
            ;;
    esac
}

# Play the next track based on the currently playing media or last played media
next_track() {
    SOURCE="$(check_playing_media)"
    [ -z "$SOURCE" ] && SOURCE="$(cat $LAST_PLAYED_FILE)"

    case "$SOURCE" in
        mpc#*)
            mpc next > /dev/null
            ;;
        playerctl#*)
            playerctl next > /dev/null
            ;;
        mpv#*)
            MPV_PID=$(pgrep -n mpv)
            MPV_SOCKET="/tmp/mpvSockets/${MPV_PID}"
            echo '{ "command": ["playlist-next"] }' | socat - "$MPV_SOCKET" > /dev/null
            ;;
        *)
            mpc next > /dev/null # defaults to mpc
            ;;
    esac
}

# Play the previous track based on the currently playing media or last played media
previous_track() {
    SOURCE="$(check_playing_media)"
    [ -z "$SOURCE" ] && SOURCE="$(cat $LAST_PLAYED_FILE)"

    case "$SOURCE" in
        mpc#*)
            mpc prev > /dev/null
            ;;
        playerctl#*)
            playerctl previous > /dev/null
            ;;
        mpv#*)
            MPV_PID=$(pgrep -n mpv)
            MPV_SOCKET="/tmp/mpvSockets/${MPV_PID}"
            echo '{ "command": ["playlist-prev"] }' | socat - "$MPV_SOCKET" > /dev/null
            ;;
        *)
            mpc prev > /dev/null # defaults to mpc
            ;;
    esac
}

# Main logic to handle command-line arguments
case "$1" in
    "")
        get_media_title
        ;;
    "toggle")
        toggle_play
        ;;
    "next")
        next_track
        ;;
    "prev")
        previous_track
        ;;
    *)
        echo "Usage: $0 [toggle|next|prev]"
        exit 1
        ;;
esac
